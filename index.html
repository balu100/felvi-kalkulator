<!DOCTYPE html>
<html lang="hu">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>√âretts√©gi pontsz√°m√≠t√≥ 2025/2026 ‚Ä¢ friss√≠tve: 2025-12-24</title>
  <style>
    :root {
      --bg: #fff;
      --fg: #111;
      --muted: #666;
      --line: #e5e5e5;
      --accent: #111;
      --ok: #0a0;
      --warn: #a60;
      --err: #a00;
      --soft: #f8f8f8;
    }

    .dark {
      --bg: #111;
      --fg: #eee;
      --muted: #aaa;
      --line: #2a2a2a;
      --accent: #fff;
      --ok: #65d665;
      --warn: #e0a85c;
      --err: #ff6b6b;
      --soft: #1a1a1a;
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      color: var(--fg);
      background: var(--bg);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 3;
      background: var(--bg);
      border-bottom: 1px solid var(--line)
    }

    .wrap {
      max-width: 1100px;
      margin-inline: auto;
      padding: 10px 16px
    }

    h1 {
      font-size: 20px;
      margin: 8px 0
    }

    .sub {
      color: var(--muted);
      font-size: 13px
    }

    .grid {
      display: grid;
      gap: 14px
    }

    @media(min-width:900px) {
      .grid.cols-2 {
        grid-template-columns: 1fr 1fr
      }
    }

    fieldset {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px
    }

    legend {
      padding: 0 6px;
      color: var(--muted);
      font-size: 12px
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px
    }

    select,
    input[disabled],
    input[type="url"],
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: var(--bg);
      color: var(--fg)
    }

    .row {
      display: grid;
      grid-template-columns: 1.5fr .8fr .8fr;
      gap: 10px;
      align-items: end
    }

    .row.compact {
      grid-template-columns: 1fr 1fr 1fr 1fr
    }

    .row>div {
      min-width: 0
    }

    .section-title {
      font-weight: 600;
      margin: 6px 0 2px
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      cursor: pointer;
      user-select: none
    }

    .pill input {
      accent-color: var(--accent)
    }

    .pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .muted {
      color: var(--muted)
    }

    .help {
      font-size: 12px;
      color: var(--muted)
    }

    .warn {
      color: var(--warn)
    }

    .err {
      color: var(--err)
    }

    .ok {
      color: var(--ok)
    }

    .divider {
      height: 1px;
      background: var(--line);
      margin: 8px 0
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center
    }

    button {
      border: 1px solid var(--line);
      background: var(--bg);
      color: var(--fg);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    button.primary {
      background: var(--fg);
      color: var(--bg)
    }

    .footer {
      position: sticky;
      bottom: 0;
      z-index: 3;
      border-top: 1px solid var(--line);
      background: color-mix(in oklab, var(--bg) 97%, transparent);
      backdrop-filter: saturate(140%) blur(6px)
    }

    .totals {
      display: grid;
      gap: 8px;
      align-items: center
    }

    @media(min-width:900px) {
      .totals {
        grid-template-columns: 1fr auto
      }
    }

    .sumline {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: baseline
    }

    .sumline b {
      font-size: 20px
    }

    .badge {
      border: 1px solid var(--line);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px
    }

    .kpi {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap
    }

    .kpi span {
      font-size: 12px;
      color: var(--fg)
    }

    .kpi b {
      font-size: 18px
    }

    .errorbox {
      border: 1px solid color-mix(in oklab, var(--err) 30%, var(--bg));
      background: color-mix(in oklab, var(--err) 6%, var(--bg));
      color: var(--err);
      padding: 8px 10px;
      border-radius: 8px
    }

    .okbox {
      border: 1px solid color-mix(in oklab, var(--ok) 30%, var(--bg));
      background: color-mix(in oklab, var(--ok) 6%, var(--bg));
      color: color-mix(in oklab, var(--ok) 70%, black);
      padding: 8px 10px;
      border-radius: 8px
    }

    .sticky-note {
      font-size: 12px;
      color: var(--muted)
    }

    .ghost {
      opacity: .6
    }

    .soft {
      background: var(--soft)
    }

    .hdr-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    .chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid var(--line);
      border-radius: 999px
    }

    details {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: color-mix(in oklab, var(--bg) 92%, var(--soft));
    }

    details>summary {
      cursor: pointer;
      font-weight: 600;
    }

    details[open] {
      background: var(--bg);
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap hdr-actions">
      <div style="flex:1">
        <h1>√âretts√©gi pontsz√°m√≠t√≥ <span class="muted">2025/2026</span></h1>
        <div class="sub">Param√©terezhet≈ë (2025K/2026K). Mobilbar√°t. Link-megoszt√°s √©s helyi ment√©s.</div>
      </div>
      <button id="themeBtn" aria-label="T√©ma v√°lt√°sa">üåô/‚òÄ</button>
    </div>
  </header>

  <main class="wrap grid" style="margin-bottom:110px">

    <section class="grid">
      <fieldset>
        <legend>Szab√°lyprofil (2025/2026) √©s be√°ll√≠t√°sok</legend>
        <div class="row compact">
          <div>
            <label>Szab√°lyprofil</label>
            <select id="ruleProfile">
              <option value="2025K" selected>2025K</option>
              <option value="2026K">2026K</option>
              <option value="custom">Egy√©ni</option>
            </select>
          </div>

          <div>
            <label>Sikeres vizsga minimum (%)</label>
            <input id="passPct" type="number" min="0" max="100" step="1" value="25" />
          </div>

          <div>
            <label>K√∂z√©pszint √°tsz√°m√≠t√°s</label>
            <select id="midConv">
              <option value="two_thirds_round" selected>2/3 √ó % (kerek√≠tve)</option>
              <option value="two_thirds_floor">2/3 √ó % (lefel√©)</option>
              <option value="equal">pont = %</option>
            </select>
          </div>

          <div>
            <label>Int√©zm√©nyi pont max</label>
            <input id="instMax" type="number" min="0" max="200" step="1" value="100" />
          </div>
        </div>

        <div class="help" style="margin-top:8px">
          Ezek a param√©terek olyan r√©szeket fednek le, amik pontsz√°mot m√≥dos√≠thatnak. Az int√©zm√©nyi pontok tartalma
          szakonk√©nt elt√©r≈ë, itt csak a mennyis√©get kezeled.
        </div>

        <details style="margin-top:10px">
          <summary>Halad√≥: Sport fix pont √©s katonai opci√≥k</summary>
          <div class="row compact" style="margin-top:10px">
            <div>
              <label>Sport ‚Äûfix‚Äù alap pont</label>
              <input id="sportBase" type="number" min="0" max="800" step="1" value="500" />
            </div>
            <div>
              <label>Katonai opci√≥k (CSV)</label>
              <input id="milCsv" type="text" value="0,16,32,64" />
            </div>
            <div>
              <label>Megjegyz√©s</label>
              <div class="muted" style="padding:9px 0">CSV pl.: 0,16,32,64</div>
            </div>
            <div>
              <label> </label>
              <div class="muted" style="padding:9px 0"></div>
            </div>
          </div>
        </details>
      </fieldset>
    </section>

    <section>
      <div class="section-title">M√≥d</div>
      <div class="pills" id="modePills">
        <label class="pill"><input type="radio" name="mode" value="standard" checked> Standard (tanulm√°nyi + √©retts√©gi /
          √©retts√©gi√ó2)</label>
        <label class="pill"><input type="radio" name="mode" value="practice"> Gyakorlati vizsg√°s szak</label>
        <label class="pill"><input type="radio" name="mode" value="sport500"> Nemzetk√∂zi √©lsport (fix pont)</label>
      </div>
      <div class="help">
        ‚Ä¢ Gyakorlati szakokon: √∂sszpont = gyakorlati √ó2; int√©zm√©nyi pont nem adhat√≥ (csak katonai t√∂bblet). ‚Ä¢ Sport m√≥d:
        fix alap pont; a szak k√∂telez≈ë felt√©teleit (min. vizsg√°k stb.) k√ºl√∂n kell teljes√≠teni.
      </div>
      <div class="divider"></div>
    </section>

    <section id="standardPanel" class="grid cols-2">
      <fieldset>
        <legend>Tanulm√°nyi pontok (max 200)</legend>

        <div class="section-title">1) K√∂z√©piskolai √©v v√©gi jegyek ‚Äì 0‚Ä¶100 pont</div>
        <div class="help">A k√©t utols√≥ tanult √©v jegyei t√°rgyank√©nt √∂sszeadva, majd √ó2. Magyar nyelv √©s irodalomn√°l
          √©vk√©nt: (nyelv + irodalom)/2.</div>
        <div id="grades"></div>

        <div class="divider"></div>

        <div class="section-title">2) √âretts√©gi √°tlag (max 100)</div>
        <div class="help">A megadott (nem √ºres) %-ok √°tlaga eg√©szre kerek√≠tve. Ha kevesebb mint 5 van megadva, annyib√≥l
          sz√°mol.</div>
        <div id="eriAvg"></div>

        <div class="sticky-note" style="margin-top:6px">Megnevez√©sek: ‚ÄûInformatika (Digit√°lis kult√∫ra)‚Äù a kor√°bbi
          ‚ÄûInformatika‚Äù helyett terjedt el.</div>
      </fieldset>

      <fieldset>
        <legend>√âretts√©gi pontok (max 200)</legend>
        <div class="help">K√©t vizsgat√°rgy. Emelt: pont = %. K√∂z√©p: a kiv√°lasztott √°tsz√°m√≠t√°s szerint.</div>

        <div id="eriPoints"></div>

        <div class="divider"></div>

        <label class="pill" style="margin-top:6px">
          <input type="checkbox" id="useVET"> Technikumi/szakmai vizsga (VET) haszn√°lata az egyik t√°rgy helyett
        </label>

        <div id="vetRow" style="display:none; margin-top:8px">
          <div class="row compact">
            <div>
              <label>VET t√≠pus</label>
              <select id="vetType">
                <option value="emelt">Technikumi oklev√©l (emeltk√©nt kezelve)</option>
                <option value="kozep">Szakk√©pes√≠t≈ë / OKJ-ut√≥d (k√∂z√©pk√©nt kezelve)</option>
              </select>
            </div>

            <div>
              <label>Vizsgaeredm√©ny (%)</label>
              <select id="vetPct"></select>
            </div>

            <div>
              <label>Melyik t√°rgy helyett?</label>
              <select id="vetReplace">
                <option value="0">1. vizsgat√°rgy</option>
                <option value="1">2. vizsgat√°rgy</option>
              </select>
            </div>

            <div>
              <label>Pont (VET + m√°sik t√°rgy)</label>
              <input id="vetPts" disabled value="‚Äì" class="soft" />
            </div>
          </div>
          <div class="help">‚Ñπ A VET t√°rgyat helyettes√≠t (ha a szak elfogadja), de emelt-szint k√∂telezetts√©get nem
            felt√©tlen v√°lt ki.</div>
        </div>

        <div class="divider"></div>

        <label class="pill" style="margin-top:6px">
          <input type="checkbox" id="useFFSZV"> Fels≈ëoktat√°si felv√©teli szakmai vizsga (FFSZV) haszn√°lata az egyik t√°rgy
          helyett
        </label>

        <div id="ffszvRow" style="display:none; margin-top:8px">
          <div class="row compact">
            <div>
              <label>FFSZV eredm√©ny (%)</label>
              <select id="ffszvPct"></select>
            </div>
            <div>
              <label>Melyik t√°rgy helyett?</label>
              <select id="ffszvReplace">
                <option value="0">1. vizsgat√°rgy</option>
                <option value="1">2. vizsgat√°rgy</option>
              </select>
            </div>
            <div>
              <label>Pont (FFSZV + m√°sik t√°rgy)</label>
              <input id="ffszvPts" disabled value="‚Äì" class="soft" />
            </div>
            <div>
              <label> </label>
              <div class="muted" style="padding:9px 0"></div>
            </div>
          </div>
          <div class="help">‚Ñπ A pontsz√°m√≠t√°sn√°l a vizsg√°n el√©rt sz√°zal√©kos eredm√©ny vehet≈ë figyelembe.</div>
        </div>

        <div class="divider"></div>

        <details>
          <summary>Opcion√°lis: VET-hez kapcsol√≥d√≥ sz√°m√≠t√°si m√≥dok</summary>
          <div class="help" style="margin-top:6px">
            VET haszn√°latakor n√©h√°ny szak/elj√°r√°s eset√©n a kiv√°lasztott m√≥d befoly√°solhatja, mely k√©plet a ‚Äûb√°zis‚Äù
            sz√°m√≠t√°s alapja.
          </div>
          <div class="row compact" style="margin-top:8px">
            <div>
              <label>VET k√©plet (ha VET akt√≠v)</label>
              <select id="vetMode">
                <option value="auto" selected>Auto (max a megengedettekb≈ël)</option>
                <option value="exam_plus_vet2">√âretts√©gi + (VET√ó2)</option>
                <option value="vet4">VET√ó4</option>
              </select>
            </div>
            <div>
              <label> </label>
              <div class="muted" style="padding:9px 0">Auto: a standard k√©pletekkel is √∂sszevet.</div>
            </div>
            <div><label> </label>
              <div class="muted" style="padding:9px 0"></div>
            </div>
            <div><label> </label>
              <div class="muted" style="padding:9px 0"></div>
            </div>
          </div>
        </details>
      </fieldset>

      <fieldset>
        <legend>Szak-szab√°lyok ellen≈ërz√©se (opcion√°lis)</legend>
        <div class="chips" id="progSubjects"></div>
        <div class="row compact" style="margin-top:8px">
          <div>
            <label>Min. emelt szint≈± √©retts√©gi az elfogadott t√°rgyakb√≥l</label>
            <select id="minEmelt">
              <option value="0">0</option>
              <option value="1" selected>1</option>
              <option value="2">2</option>
            </select>
          </div>
          <div>
            <label>Meghirdet√©s linkje (Felvi / egyetem)</label>
            <input id="progLink" type="url" placeholder="https://www.felvi.hu/..." />
          </div>
          <div>
            <label>Link m≈±veletek</label>
            <div class="controls">
              <button id="openProg" type="button">Megnyit√°s</button>
            </div>
          </div>
          <div>
            <label> </label>
            <div class="muted" style="padding:9px 0"></div>
          </div>
        </div>
        <div class="help">V√°laszd ki az elfogadott t√°rgyakat. A kalkul√°tor jelez, ha a kiv√°lasztott 2 √©retts√©gi t√°rgy
          nem felel meg, vagy nincs meg a min. emelt.</div>
      </fieldset>

      <fieldset>
        <legend>Int√©zm√©nyi √©s katonai pontok</legend>
        <div class="row compact">
          <div>
            <label>Int√©zm√©nyi pontok (0‚Äìmax)</label>
            <select id="instPts"></select>
          </div>
          <div>
            <label>√ñnk√©ntes katonai pont</label>
            <select id="milPts"></select>
          </div>
          <div>
            <label>Megoszthat√≥ link</label>
            <button id="shareBtn">Link m√°sol√°sa</button>
          </div>
          <div>
            <label>Adatok</label>
            <div class="controls">
              <button id="resetBtn">Vissza√°ll√≠t√°s</button>
              <button id="saveBtn" class="primary">Ment√©s</button>
            </div>
          </div>
        </div>
        <div class="help">Az int√©zm√©nyi pontokat a fels≈ëoktat√°si int√©zm√©ny szabja meg szakonk√©nt (itt csak a darabsz√°mot
          adod meg).</div>
      </fieldset>
    </section>

    <section id="practicePanel" style="display:none">
      <fieldset>
        <legend>Gyakorlati vizsg√°s szakok</legend>
        <div class="row compact">
          <div>
            <label>Gyakorlati maximum</label>
            <select id="practiceMax">
              <option value="200" selected>200</option>
              <option value="100">100</option>
            </select>
          </div>
          <div>
            <label>Gyakorlati pont (0‚Äìmax)</label>
            <select id="practiceScore"></select>
          </div>
          <div>
            <label>√ñnk√©ntes katonai pont</label>
            <select id="milPtsPractice"></select>
          </div>
          <div>
            <label>Megoszthat√≥ link</label>
            <button id="shareBtn2">Link m√°sol√°sa</button>
          </div>
        </div>
        <div class="okbox" style="margin-top:8px">
          √ñsszpontsz√°m = gyakorlati pont √ó 2. Int√©zm√©nyi pont nem adhat√≥. Csak az √∂nk√©ntes katonai t√∂bbletpont
          sz√°m√≠that√≥.
        </div>
      </fieldset>
    </section>

    <section id="sportPanel" style="display:none">
      <fieldset>
        <legend>Nemzetk√∂zi √©lsport eredm√©ny</legend>
        <div class="okbox">
          Jogosults√°g eset√©n a felv√©teli √∂sszpontsz√°m: <b><span id="sportBaseText">500</span> pont</b>.
        </div>
        <div class="controls" style="margin-top:8px">
          <button id="shareBtn3">Link m√°sol√°sa</button>
        </div>
      </fieldset>
    </section>

    <section>
      <fieldset>
        <legend>Dokumentumok √©s hat√°rid≈ëk</legend>
        <ul class="help" style="margin:0 0 6px 16px; padding:0">
          <li>Bizony√≠tv√°nyoldalak felt√∂lt√©se az E-felv√©teliben a tanulm√°nyi pontokhoz.</li>
          <li>Nyelvvizsga / VET / technikumi oklev√©l / egy√©b igazol√°sok felt√∂lt√©se (ha relev√°ns).</li>
          <li>Hat√°rid≈ëk: a meghirdet√©s oldalain √©s a k√∂zponti t√°j√©koztat√≥ban.</li>
        </ul>
        <div class="sticky-note">Hasznos: felvi.hu ‚Ä¢ oktatas.hu ‚Ä¢ eduline.hu</div>
      </fieldset>
    </section>

  </main>

  <footer class="footer">
    <div class="wrap totals">
      <div class="sumline">
        <span class="badge">Alap</span>
        <span>Tanulm√°nyi: <b id="sumStudy">0</b></span>
        <span>√âretts√©gi: <b id="sumExam">0</b></span>
        <span class="muted">k√©plet: <b id="formula">‚Äì</b></span>
        <span>| Int√©zm√©nyi: <b id="sumInst">0</b></span>
        <span>| Katonai: <b id="sumMil">0</b></span>
        <span class="badge ghost" id="maxBadge">Max: ‚Äì</span>
      </div>
      <div class="kpi"><span>V√©g√∂sszeg:</span><b id="grandTotal">0</b></div>
    </div>
  </footer>

  <script>
    (function () {
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const toInt = v => parseInt(v, 10) || 0;
      const clamp = (n, min, max) => Math.min(max, Math.max(min, n));
      const toPct = v => (v === '' || v == null) ? null : (Number.isFinite(Number(v)) ? Number(v) : null);

      // Theme
      const themeBtn = $('#themeBtn');
      function setTheme(mode) {
        document.body.classList.toggle('dark', mode === 'dark');
        localStorage.setItem('erettsegi_calc_theme', mode);
      }
      themeBtn?.addEventListener('click', () => {
        const now = document.body.classList.contains('dark') ? 'light' : 'dark';
        setTheme(now);
      });
      setTheme(localStorage.getItem('erettsegi_calc_theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

      // Rule profiles (param√©terezhet≈ë)
      const RULE_PROFILES = {
        "2025K": { passPct: 25, midConv: "two_thirds_round", instMax: 100, sportBase: 500, milCsv: "0,16,32,64" },
        "2026K": { passPct: 25, midConv: "two_thirds_round", instMax: 100, sportBase: 500, milCsv: "0,16,32,64" },
        "custom": { passPct: 25, midConv: "two_thirds_round", instMax: 100, sportBase: 500, milCsv: "0,16,32,64" }
      };

      function parseMilCsv(s) {
        const arr = (s || "")
          .split(',')
          .map(x => x.trim())
          .filter(Boolean)
          .map(x => Number(x))
          .filter(n => Number.isFinite(n))
          .map(n => Math.round(n))
          .filter(n => n >= 0 && n <= 200);

        const uniq = Array.from(new Set(arr));
        uniq.sort((a, b) => a - b);
        return uniq.length ? uniq : [0, 16, 32, 64];
      }

      function getRules() {
        const prof = $('#ruleProfile').value || '2025K';
        const base = RULE_PROFILES[prof] || RULE_PROFILES["2025K"];

        const passPct = clamp(toInt($('#passPct').value), 0, 100);
        const midConv = $('#midConv').value || base.midConv;
        const instMax = clamp(toInt($('#instMax').value), 0, 200);
        const sportBase = clamp(toInt($('#sportBase').value), 0, 800);
        const milCsv = ($('#milCsv').value || base.milCsv);
        const milOptions = parseMilCsv(milCsv);

        return { profile: prof, passPct, midConv, instMax, sportBase, milOptions, milCsv };
      }

      function applyProfile(profile) {
        const p = RULE_PROFILES[profile] || RULE_PROFILES["2025K"];
        $('#passPct').value = String(p.passPct);
        $('#midConv').value = p.midConv;
        $('#instMax').value = String(p.instMax);
        $('#sportBase').value = String(p.sportBase);
        $('#milCsv').value = p.milCsv;
      }

      // Select fillers
      function fillPercentSelect(sel, start = 0, withBlank = false) {
        sel.innerHTML = '';
        if (withBlank) {
          const z = document.createElement('option');
          z.value = '';
          z.textContent = '‚Äî';
          sel.appendChild(z);
        }
        for (let i = start; i <= 100; i++) {
          const o = document.createElement('option');
          o.value = String(i);
          o.textContent = String(i);
          sel.appendChild(o);
        }
      }

      function fillRangeSelect(sel, start, end) {
        sel.innerHTML = '';
        for (let i = start; i <= end; i++) {
          const o = document.createElement('option');
          o.value = String(i);
          o.textContent = String(i);
          sel.appendChild(o);
        }
      }

      function fillFromArray(sel, arr, includeBlank = false) {
        sel.innerHTML = '';
        if (includeBlank) {
          const z = document.createElement('option');
          z.value = '';
          z.textContent = '‚Äî';
          sel.appendChild(z);
        }
        arr.forEach(v => {
          const o = document.createElement('option');
          o.value = String(v);
          o.textContent = String(v);
          sel.appendChild(o);
        });
      }

      // Tant√°rgylista (r√∂vid√≠tett, de b≈ëv√≠thet≈ë)
      const subjectsAll = [
        'Magyar nyelv √©s irodalom', 'Matematika', 'T√∂rt√©nelem',
        'Angol nyelv', 'N√©met nyelv', 'Francia nyelv', 'Olasz nyelv', 'Spanyol nyelv', 'Orosz nyelv',
        'Biol√≥gia', 'Fizika', 'K√©mia', 'F√∂ldrajz',
        'Informatika (Digit√°lis kult√∫ra)', 'Informatika',
        'Gazdas√°gi ismeretek', '√Ållampolg√°ri ismeretek',
        '√ânek-zene', 'Rajz √©s vizu√°lis kult√∫ra', 'M≈±v√©szett√∂rt√©net',
        'Filoz√≥fia', 'Dr√°ma', 'T√°rsadalomismeret'
      ];

      // --- Build UI dynamic parts ---
      // Grades (tanulm√°nyi jegyek)
      const gradesHost = $('#grades');
      const gradeSubjects = [
        { key: 'magyar', label: 'Magyar nyelv √©s irodalom (nyelv + irodalom)' },
        { key: 'tori', label: 'T√∂rt√©nelem' },
        { key: 'matek', label: 'Matematika' },
        { key: 'nyelv', label: 'Idegen nyelv (lent v√°laszthat√≥)' },
        { key: 'valasztott', label: 'V√°lasztott (int√©zm√©ny √°ltal elfogadott)' }
      ];

      gradesHost.innerHTML = gradeSubjects.map(s => {
        if (s.key === 'magyar') {
          return `
            <div class="row compact" data-key="${s.key}">
              <div>
                <label>${s.label} ‚Äì utols√≥ el≈ëtti √©v</label>
                <div class="controls">
                  <div style="flex:1;min-width:110px">
                    <div class="help">Nyelv</div>
                    <select class="gradeA_lang"></select>
                  </div>
                  <div style="flex:1;min-width:110px">
                    <div class="help">Irodalom</div>
                    <select class="gradeA_lit"></select>
                  </div>
                </div>
              </div>
              <div>
                <label>${s.label} ‚Äì utols√≥ √©v</label>
                <div class="controls">
                  <div style="flex:1;min-width:110px">
                    <div class="help">Nyelv</div>
                    <select class="gradeB_lang"></select>
                  </div>
                  <div style="flex:1;min-width:110px">
                    <div class="help">Irodalom</div>
                    <select class="gradeB_lit"></select>
                  </div>
                </div>
              </div>
              <div><label>Jegyek √∂sszege√ó2</label><input disabled value="‚Äì" class="gSum soft"></div>
              <div><label> </label><div class="muted" style="padding:9px 0"></div></div>
            </div>`;
        }
        return `
          <div class="row compact" data-key="${s.key}">
            <div><label>${s.label} ‚Äì utols√≥ el≈ëtti √©v</label><select class="gradeA"></select></div>
            <div><label>${s.label} ‚Äì utols√≥ √©v</label><select class="gradeB"></select></div>
            <div><label>Jegyek √∂sszege√ó2</label><input disabled value="‚Äì" class="gSum soft"></div>
            <div>${s.key === 'nyelv'
            ? `<label>V√°lasztott nyelv</label><select class="langPick"></select>`
            : `<label> </label><div class="muted" style="padding:9px 0"></div>`
          }</div>
          </div>`;
      }).join('');

      // Fill grade selects (1..5)
      $$('#grades select.gradeA, #grades select.gradeB, #grades select.gradeA_lang, #grades select.gradeA_lit, #grades select.gradeB_lang, #grades select.gradeB_lit')
        .forEach(sel => fillRangeSelect(sel, 1, 5));

      // Fill language picker
      $$('#grades .langPick').forEach(sel => {
        ['Angol nyelv', 'N√©met nyelv', 'Francia nyelv', 'Olasz nyelv', 'Spanyol nyelv', 'Orosz nyelv'].forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          sel.appendChild(o);
        });
      });

      // √âretts√©gi √°tlag
      const eriAvgHost = $('#eriAvg');
      const eriAvgRows = [
        { key: 'magyarP', label: 'Magyar nyelv √©s irodalom %' },
        { key: 'toriP', label: 'T√∂rt√©nelem %' },
        { key: 'matekP', label: 'Matematika %' },
        { key: 'nyelvP', label: 'Idegen nyelv %' },
        { key: 'valasztottP', label: 'V√°lasztott t√°rgy %' },
      ];
      eriAvgHost.innerHTML = eriAvgRows.map(r => `
        <div class="row compact" data-key="${r.key}">
          <div><label>${r.label}</label><select class="pct-avg"></select></div>
          <div><label> </label><div class="muted" style="padding:9px 0">‚Äî vagy 0‚Äì100%</div></div>
          <div><label> </label><div class="muted" style="padding:9px 0"></div></div>
          <div><label> </label><div class="muted" style="padding:9px 0"></div></div>
        </div>
      `).join('');
      $$('#eriAvg select.pct-avg').forEach(sel => fillPercentSelect(sel, 0, true));

      // √âretts√©gi pontok (2 t√°rgy)
      const eriHost = $('#eriPoints');
      eriHost.innerHTML = [0, 1].map(i => `
        <div class="row exam-row" data-exam="${i}">
          <div>
            <label>Vizsgat√°rgy</label>
            <select class="subj"></select>
            <div class="help">Tipp: ha nincs a list√°ban, a ‚ÄûSzak-szab√°lyok‚Äù r√©sz csak ir√°nymutat√≥.</div>
          </div>
          <div><label>Szint</label><select class="lvl"><option value="emelt">Emelt</option><option value="kozep">K√∂z√©p</option></select></div>
          <div><label>Eredm√©ny (%)</label><select class="pct"></select></div>
        </div>
      `).join('');
      $$('#eriPoints .pct').forEach(sel => fillPercentSelect(sel, 0, true));
      $$('#eriPoints .subj').forEach(sel => {
        subjectsAll.forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          sel.appendChild(o);
        });
      });

      // VET / FFSZV selects
      fillPercentSelect($('#vetPct'), 0, true);
      fillPercentSelect($('#ffszvPct'), 0, true);

      // Program rules chips
      const progHost = $('#progSubjects');
      progHost.innerHTML = subjectsAll.map(s => {
        const id = 'sub_' + s.replace(/[^a-z0-9]+/gi, '_');
        return `<label class="chip"><input type="checkbox" class="progSub" id="${id}" value="${s}"> <span>${s}</span></label>`;
      }).join('');

      // Fill institutional + military selects based on current rules
      function refreshInstAndMilSelects() {
        const rules = getRules();

        // Inst pts
        const instSel = $('#instPts');
        const currentInst = toInt(instSel.value);
        fillRangeSelect(instSel, 0, rules.instMax);
        instSel.value = String(clamp(currentInst, 0, rules.instMax));

        // Mil pts (standard + practice)
        const milS = $('#milPts');
        const milP = $('#milPtsPractice');
        const curMilS = toInt(milS.value);
        const curMilP = toInt(milP.value);

        fillFromArray(milS, rules.milOptions, false);
        fillFromArray(milP, rules.milOptions, false);

        milS.value = String(rules.milOptions.includes(curMilS) ? curMilS : rules.milOptions[0]);
        milP.value = String(rules.milOptions.includes(curMilP) ? curMilP : rules.milOptions[0]);

        // Sport base
        $('#sportBaseText').textContent = String(rules.sportBase);
      }

      // Practice select
      function fillPracticeScore() {
        const max = toInt($('#practiceMax').value) || 200;
        fillRangeSelect($('#practiceScore'), 0, max);
      }
      fillPracticeScore();

      // Mode switching
      const modeRadios = $$('input[name="mode"]');

      function refreshMaxBadge() {
        const mode = modeRadios.find(r => r.checked)?.value || 'standard';
        const rules = getRules();
        const maxMil = Math.max(...rules.milOptions);

        if (mode === 'sport500') {
          $('#maxBadge').textContent = `Max: ${rules.sportBase} (sport fix)`;
          return;
        }

        if (mode === 'practice') {
          const pMax = toInt($('#practiceMax')?.value || '200');
          const practiceMaxTotal = pMax * 2 + maxMil;
          $('#maxBadge').textContent = `Max: ${practiceMaxTotal} (gyakorlati√ó2 + katonai)`;
          return;
        }

        // standard
        const standardMax = 400 + rules.instMax + maxMil;
        $('#maxBadge').textContent = `Max: ${standardMax} (400 + int√©zm√©nyi + katonai)`;
      }

      function refreshMode() {
        const mode = modeRadios.find(r => r.checked)?.value || 'standard';
        $('#standardPanel').style.display = mode === 'standard' ? '' : 'none';
        $('#practicePanel').style.display = mode === 'practice' ? '' : 'none';
        $('#sportPanel').style.display = mode === 'sport500' ? '' : 'none';

        const mp = $('#milPtsPractice');
        if (mp) mp.disabled = (mode !== 'practice');

        refreshMaxBadge();
        calc();
      }
      modeRadios.forEach(r => r.addEventListener('change', refreshMode));

      // Toggle VET / FFSZV rows (mutually exclusive)
      $('#useVET').addEventListener('change', e => {
        if (e.target.checked) {
          $('#useFFSZV').checked = false;
          $('#ffszvRow').style.display = 'none';
        }
        $('#vetRow').style.display = e.target.checked ? '' : 'none';
        calc();
      });

      $('#useFFSZV').addEventListener('change', e => {
        if (e.target.checked) {
          $('#useVET').checked = false;
          $('#vetRow').style.display = 'none';
        }
        $('#ffszvRow').style.display = e.target.checked ? '' : 'none';
        calc();
      });

      $('#vetPct').addEventListener('change', calc);
      $('#vetType').addEventListener('change', calc);
      $('#vetReplace')?.addEventListener('change', calc);
      $('#vetMode')?.addEventListener('change', calc);

      $('#ffszvPct').addEventListener('change', calc);
      $('#ffszvReplace')?.addEventListener('change', calc);

      // Practice events
      $('#practiceMax').addEventListener('change', () => {
        fillPracticeScore();
        refreshMaxBadge();
        calc();
      });
      $('#practiceScore').addEventListener('change', calc);

      // Program link
      $('#openProg').addEventListener('click', () => {
        const u = $('#progLink').value;
        if (u) window.open(u, '_blank', 'noopener,noreferrer');
      });

      function getProgRules() {
        const accepted = $$('.progSub:checked').map(cb => cb.value);
        const minEmelt = toInt($('#minEmelt').value || '0');
        const link = $('#progLink').value || '';
        return { accepted, minEmelt, link };
      }

      // Rule profile events
      $('#ruleProfile').addEventListener('change', () => {
        const prof = $('#ruleProfile').value || '2025K';
        applyProfile(prof);
        refreshInstAndMilSelects();
        refreshMaxBadge();
        calc();
      });

      ['passPct', 'midConv', 'instMax', 'sportBase', 'milCsv'].forEach(id => {
        $('#' + id).addEventListener('change', () => {
          refreshInstAndMilSelects();
          refreshMaxBadge();
          calc();
        });
      });

      // Watch changes for calc()
      document.addEventListener('change', (e) => {
        if (e.target.closest('#grades') ||
          e.target.closest('#eriAvg') ||
          e.target.closest('#eriPoints') ||
          e.target.closest('#practicePanel') ||
          e.target.id === 'instPts' ||
          e.target.id === 'milPts' ||
          e.target.id === 'milPtsPractice' ||
          e.target.classList.contains('progSub') ||
          e.target.id === 'minEmelt') {
          calc();
        }
      });

      // --- Calculations ---
      function gradesPart() {
        let sumGrades = 0;
        $$('#grades .row.compact').forEach(row => {
          const key = row.dataset.key;
          let a = 0, b = 0;
          if (key === 'magyar') {
            const aLang = toInt(row.querySelector('.gradeA_lang').value);
            const aLit = toInt(row.querySelector('.gradeA_lit').value);
            const bLang = toInt(row.querySelector('.gradeB_lang').value);
            const bLit = toInt(row.querySelector('.gradeB_lit').value);
            a = (aLang + aLit) / 2;
            b = (bLang + bLit) / 2;
          } else {
            a = toInt(row.querySelector('.gradeA').value);
            b = toInt(row.querySelector('.gradeB').value);
          }
          const rowPts = Math.round((a + b) * 2);
          row.querySelector('.gSum').value = String(rowPts);
          sumGrades += (a + b);
        });
        const total = Math.round(sumGrades * 2);
        return clamp(total, 0, 100);
      }

      function eriAvgPart() {
        const vals = $$('#eriAvg .pct-avg')
          .map(s => s.value)
          .filter(v => v !== '')
          .map(v => toInt(v));

        if (vals.length === 0) return 0;
        return Math.round(vals.reduce((a, b) => a + b, 0) / vals.length);
      }

      function midExamPoints(pct) {
        const rules = getRules();
        if (pct == null || pct < rules.passPct) return 0;

        const v = clamp(pct, 0, 100);
        if (rules.midConv === 'equal') return v;
        if (rules.midConv === 'two_thirds_floor') return Math.floor(v * 2 / 3);
        return Math.round(v * 2 / 3);
      }

      function examPointsForLevel(lvl, pct) {
        const rules = getRules();
        if (pct == null || pct < rules.passPct) return 0;
        return (lvl === 'emelt') ? clamp(pct, 0, 100) : midExamPoints(pct);
      }

      function readExamParts() {
        const rules = getRules();
        const rows = $$('#eriPoints .exam-row');
        return rows.map(r => {
          const subj = r.querySelector('.subj').value;
          const lvl = r.querySelector('.lvl').value;
          const pct = toPct(r.querySelector('.pct').value);
          const passed = pct !== null && pct >= rules.passPct;
          const pts = examPointsForLevel(lvl, pct);
          return { subj, lvl, pct, passed, pts };
        });
      }

      function examPoints() {
        const rules = getRules();
        const parts = readExamParts();

        const useVET = $('#useVET').checked;
        const useFFSZV = $('#useFFSZV').checked;

        // Default reset
        $('#vetPts').value = '‚Äì';
        $('#ffszvPts').value = '‚Äì';

        // Mutual exclusion already enforced in UI, but keep safe:
        if (useVET && useFFSZV) {
          // prefer VET
          $('#useFFSZV').checked = false;
          $('#ffszvRow').style.display = 'none';
        }

        if (useVET) {
          const vetPct = toPct($('#vetPct').value);
          const vetType = $('#vetType').value;
          const vetPassed = vetPct !== null && vetPct >= rules.passPct;
          const vetPts = examPointsForLevel(vetType, vetPct);

          const replaceIdx = toInt($('#vetReplace')?.value ?? '0');
          const otherIdx = replaceIdx === 0 ? 1 : 0;
          const other = parts[otherIdx];

          const valid = vetPassed && !!other?.passed;
          const total = clamp(vetPts + (other?.pts || 0), 0, 200);

          $('#vetPts').value = String(total);

          return {
            total,
            valid,
            parts,
            special: { kind: 'VET', pct: vetPct, lvl: vetType, passed: vetPassed, pts: vetPts, replaceIdx, otherIdx }
          };
        }

        if (useFFSZV) {
          const fPct = toPct($('#ffszvPct').value);
          const fPassed = fPct !== null && fPct >= rules.passPct;

          // FFSZV: pont = % (emeltk√©nt kezelve)
          const fPts = (fPct == null || fPct < rules.passPct) ? 0 : clamp(fPct, 0, 100);

          const replaceIdx = toInt($('#ffszvReplace')?.value ?? '0');
          const otherIdx = replaceIdx === 0 ? 1 : 0;
          const other = parts[otherIdx];

          const valid = fPassed && !!other?.passed;
          const total = clamp(fPts + (other?.pts || 0), 0, 200);

          $('#ffszvPts').value = String(total);

          return {
            total,
            valid,
            parts,
            special: { kind: 'FFSZV', pct: fPct, lvl: 'emelt', passed: fPassed, pts: fPts, replaceIdx, otherIdx }
          };
        }

        const valid = parts.every(p => p.passed);
        const total = clamp(parts.reduce((a, p) => a + p.pts, 0), 0, 200);
        return { total, valid, parts, special: null };
      }

      function computeStandard() {
        const g = gradesPart();
        const a = eriAvgPart();
        const study = clamp(g + a, 0, 200);

        const examRes = examPoints();
        const exam = examRes.total;

        const f1 = study + exam;
        const f2 = exam * 2;

        // VET opci√≥s k√©pletek (csak ha VET akt√≠v)
        let candidates = [
          { key: 'Tanulm√°nyi+√âretts√©gi', val: f1 },
          { key: '√âretts√©gi√ó2', val: f2 }
        ];

        const useVET = $('#useVET').checked;
        if (useVET) {
          const vetMode = $('#vetMode')?.value || 'auto';
          const special = examRes.special; // kind=VET
          const otherPts = (special && special.kind === 'VET') ? (examRes.parts[special.otherIdx]?.pts || 0) : 0;
          const vetPts = (special && special.kind === 'VET') ? (special.pts || 0) : 0;

          const examPlusVet2 = clamp(otherPts + (vetPts * 2), 0, 400); // b√°zis jel√∂lt
          const vet4 = clamp(vetPts * 4, 0, 400);

          if (vetMode === 'exam_plus_vet2') {
            candidates.push({ key: '√âretts√©gi + (VET√ó2)', val: examPlusVet2 });
          } else if (vetMode === 'vet4') {
            candidates.push({ key: 'VET√ó4', val: vet4 });
          } else {
            candidates.push({ key: '√âretts√©gi + (VET√ó2)', val: examPlusVet2 });
            candidates.push({ key: 'VET√ó4', val: vet4 });
          }
        }

        const best = candidates.reduce((m, x) => x.val > m.val ? x : m, candidates[0]);
        return { study, exam, base: best.val, formula: best.key, examRes };
      }

      function computePractice() {
        const score = toInt($('#practiceScore').value);
        const base = clamp(score * 2, 0, 400);
        return { base };
      }

      // Throttle state+URL
      let syncTimer = null;
      function scheduleSync() {
        clearTimeout(syncTimer);
        syncTimer = setTimeout(() => { saveState(); syncURL(); }, 200);
      }

      function calc() {
        const mode = modeRadios.find(r => r.checked)?.value || 'standard';
        const rules = getRules();

        let base = 0, study = 0, exam = 0, formula = '‚Äì', examRes = null;

        if (mode === 'standard') {
          const res = computeStandard();
          study = res.study;
          exam = res.exam;
          base = res.base;
          formula = res.formula;
          examRes = res.examRes;

          $('#sumInst').textContent = $('#instPts').value;
          $('#sumMil').textContent = $('#milPts').value;

        } else if (mode === 'practice') {
          const res = computePractice();
          base = res.base;
          study = 0; exam = 0; formula = 'Gyakorlati√ó2';

          $('#sumInst').textContent = '0';
          $('#sumMil').textContent = $('#milPtsPractice').value;

        } else { // sport500
          base = rules.sportBase;
          study = 0; exam = 0; formula = 'Sport fix';

          $('#sumInst').textContent = '0';
          $('#sumMil').textContent = '0';
        }

        $('#sumStudy').textContent = String(study);
        $('#sumExam').textContent = String(exam);
        $('#formula').textContent = formula;

        let total = base;
        if (mode === 'standard') {
          total = base + toInt($('#instPts').value) + toInt($('#milPts').value);
        } else if (mode === 'practice') {
          total = base + toInt($('#milPtsPractice').value);
        } else {
          total = rules.sportBase;
        }

        $('#grandTotal').textContent = String(total);

        validate(mode, examRes);
        scheduleSync();
      }

      function validate(mode, examRes) {
        const rules = getRules();
        const issues = [];

        if (mode === 'standard') {
          const parts = examRes?.parts || [];
          const subjNames = parts.map(p => p.subj);

          const useVET = $('#useVET')?.checked;
          const useFFSZV = $('#useFFSZV')?.checked;

          // 2 t√°rgy ne legyen azonos: csak ha t√©nylegesen 2 √©retts√©gi t√°rgy sz√°m√≠t (nem kiv√°lt√°s)
          if (!useVET && !useFFSZV && subjNames.length === 2 && subjNames[0] === subjNames[1]) {
            issues.push('A k√©t √©retts√©gi t√°rgy ne legyen azonos.');
          }

          // sikeress√©g ellen≈ërz√©s
          if (!useVET && !useFFSZV) {
            if (parts.filter(p => p.passed).length !== 2) {
              issues.push(`Adj meg 2 t√°rgyat legal√°bb ${rules.passPct}%-os (sikeres) eredm√©nnyel.`);
            }
          } else if (useVET) {
            const sp = examRes?.special;
            const other = parts[sp?.otherIdx ?? 1];
            if (!sp?.passed) issues.push(`A VET eredm√©nynek legal√°bb ${rules.passPct}%-nak kell lennie (sikeres).`);
            if (!other?.passed) issues.push(`A m√°sik t√°rgyn√°l legal√°bb ${rules.passPct}% sz√ºks√©ges.`);
          } else if (useFFSZV) {
            const sp = examRes?.special;
            const other = parts[sp?.otherIdx ?? 1];
            if (!sp?.passed) issues.push(`Az FFSZV eredm√©nynek legal√°bb ${rules.passPct}%-nak kell lennie (sikeres).`);
            if (!other?.passed) issues.push(`A m√°sik t√°rgyn√°l legal√°bb ${rules.passPct}% sz√ºks√©ges.`);
          }

          // √©retts√©gi √°tlaghoz legal√°bb 1 t√°rgy
          const filledAny = $$('#eriAvg .pct-avg').some(s => s.value !== '');
          if (!filledAny) issues.push('Az √©retts√©gi √°tlaghoz adj meg legal√°bb 1 t√°rgyat.');

          // program rules
          const pr = getProgRules();
          if (pr.accepted.length) {
            // Ha kiv√°lt√°s van (VET/FFSZV), a "t√°rgymegfelel√©s" ellen≈ërz√©s inform√°ci√≥ jelleg≈±.
            const notAccepted = subjNames.filter(s => !pr.accepted.includes(s));
            if (notAccepted.length) issues.push('A szak nem fogadja el: ' + notAccepted.join(', ') + '.');

            const emelts = parts
              .filter(p => p.passed && p.lvl === 'emelt' && pr.accepted.includes(p.subj))
              .length;

            if (emelts < pr.minEmelt) {
              issues.push('Nincs meg a minim√°lisan elv√°rt emelt szint (' + pr.minEmelt + ').');
              if ((useVET || useFFSZV) && pr.minEmelt > 0) {
                issues.push('Megjegyz√©s: kiv√°lt√°s (VET/FFSZV) nem felt√©tlen sz√°m√≠t emelt √©retts√©ginek.');
              }
            }
          }
        }

        if (mode === 'practice') {
          const max = toInt($('#practiceMax').value) || 200;
          const val = toInt($('#practiceScore').value) || 0;
          if (val > max) issues.push('A gyakorlati pont nem lehet nagyobb, mint a kiv√°lasztott maximum.');
        }

        // valBox a megfelel≈ë panelben
        let box = document.getElementById('valBox');
        if (!box) {
          box = document.createElement('div');
          box.id = 'valBox';
          box.style.marginTop = '8px';
        }

        const host =
          mode === 'practice' ? $('#practicePanel') :
            mode === 'sport500' ? $('#sportPanel') :
              $('#standardPanel');

        if (box.parentNode !== host) host.appendChild(box);

        if (issues.length) {
          box.className = 'errorbox';
          box.textContent = issues.join(' ‚Ä¢ ');
        } else {
          box.className = 'okbox';
          box.textContent = 'Bemenetek rendben.';
        }
      }

      // --- Share link + localStorage (v5) ---
      function currentState() {
        const rules = getRules();
        const mode = modeRadios.find(r => r.checked)?.value || 'standard';
        const state = {
          v: 5,
          mode,
          rules: {
            profile: rules.profile,
            passPct: rules.passPct,
            midConv: rules.midConv,
            instMax: rules.instMax,
            sportBase: rules.sportBase,
            milCsv: rules.milCsv
          }
        };

        if (mode === 'standard') {
          state.grades = $$('#grades .row.compact').map(r => {
            const key = r.dataset.key;
            if (key === 'magyar') {
              return {
                key,
                aLang: r.querySelector('.gradeA_lang').value,
                aLit: r.querySelector('.gradeA_lit').value,
                bLang: r.querySelector('.gradeB_lang').value,
                bLit: r.querySelector('.gradeB_lit').value
              };
            }
            return {
              key,
              a: r.querySelector('.gradeA')?.value || '',
              b: r.querySelector('.gradeB')?.value || '',
              lang: r.querySelector('.langPick')?.value || ''
            };
          });

          state.eriAvg = $$('#eriAvg .pct-avg').map(s => s.value);
          state.exams = $$('#eriPoints .exam-row').map(r => ({
            subj: r.querySelector('.subj').value,
            lvl: r.querySelector('.lvl').value,
            pct: r.querySelector('.pct').value
          }));

          state.useVET = $('#useVET').checked;
          state.vetPct = $('#vetPct').value;
          state.vetType = $('#vetType').value;
          state.vetReplace = $('#vetReplace')?.value ?? '0';
          state.vetMode = $('#vetMode')?.value ?? 'auto';

          state.useFFSZV = $('#useFFSZV').checked;
          state.ffszvPct = $('#ffszvPct').value;
          state.ffszvReplace = $('#ffszvReplace')?.value ?? '0';

          state.instPts = $('#instPts').value;
          state.milPts = $('#milPts').value;

          const pr = getProgRules();
          state.prog = { accepted: pr.accepted, minEmelt: pr.minEmelt, link: pr.link };
        } else if (mode === 'practice') {
          state.practiceScore = $('#practiceScore').value;
          state.practiceMax = $('#practiceMax').value;
          state.milPtsPractice = $('#milPtsPractice').value;
        }

        state.theme = document.body.classList.contains('dark') ? 'dark' : 'light';
        return state;
      }

      function applyState(state) {
        if (!state) return;
        if (state.theme) setTheme(state.theme);

        // rules
        if (state.rules) {
          const prof = state.rules.profile || '2025K';
          $('#ruleProfile').value = prof;
          // apply stored rule values (even if profile is not custom)
          $('#passPct').value = String(state.rules.passPct ?? 25);
          $('#midConv').value = state.rules.midConv ?? 'two_thirds_round';
          $('#instMax').value = String(state.rules.instMax ?? 100);
          $('#sportBase').value = String(state.rules.sportBase ?? 500);
          $('#milCsv').value = state.rules.milCsv ?? '0,16,32,64';
        } else if (state.v) {
          // older versions fallback
          $('#ruleProfile').value = '2025K';
          applyProfile('2025K');
        }

        refreshInstAndMilSelects();

        // mode
        if (state.mode) {
          const r = modeRadios.find(x => x.value === state.mode);
          if (r) r.checked = true;
        }
        refreshMode();

        if (state.mode === 'standard') {
          if (state.grades) {
            $$('#grades .row.compact').forEach((r, i) => {
              const key = r.dataset.key;
              const g = state.grades[i] || {};
              if (key === 'magyar') {
                if (g.aLang && g.aLit && g.bLang && g.bLit) {
                  r.querySelector('.gradeA_lang').value = g.aLang;
                  r.querySelector('.gradeA_lit').value = g.aLit;
                  r.querySelector('.gradeB_lang').value = g.bLang;
                  r.querySelector('.gradeB_lit').value = g.bLit;
                } else {
                  if (g.a) { r.querySelector('.gradeA_lang').value = g.a; r.querySelector('.gradeA_lit').value = g.a; }
                  if (g.b) { r.querySelector('.gradeB_lang').value = g.b; r.querySelector('.gradeB_lit').value = g.b; }
                }
              } else {
                if (g.a) r.querySelector('.gradeA').value = g.a;
                if (g.b) r.querySelector('.gradeB').value = g.b;
                if (g.lang && r.querySelector('.langPick')) r.querySelector('.langPick').value = g.lang;
              }
            });
          }

          if (state.eriAvg) $$('#eriAvg .pct-avg').forEach((s, i) => { if (state.eriAvg[i] != null) s.value = state.eriAvg[i]; });
          if (state.exams) $$('#eriPoints .exam-row').forEach((r, i) => {
            const e = state.exams[i] || {};
            if (e.subj) r.querySelector('.subj').value = e.subj;
            if (e.lvl) r.querySelector('.lvl').value = e.lvl;
            if (e.pct != null) r.querySelector('.pct').value = e.pct;
          });

          // VET / FFSZV (mutually exclusive)
          if (state.useVET) {
            $('#useVET').checked = true;
            $('#useFFSZV').checked = false;
            $('#vetRow').style.display = '';
            $('#ffszvRow').style.display = 'none';
          } else if (state.useFFSZV) {
            $('#useFFSZV').checked = true;
            $('#useVET').checked = false;
            $('#ffszvRow').style.display = '';
            $('#vetRow').style.display = 'none';
          } else {
            $('#useVET').checked = false; $('#vetRow').style.display = 'none';
            $('#useFFSZV').checked = false; $('#ffszvRow').style.display = 'none';
          }

          if (state.vetPct != null) $('#vetPct').value = state.vetPct;
          if (state.vetType) $('#vetType').value = state.vetType;
          if (state.vetReplace != null) $('#vetReplace').value = String(state.vetReplace);
          if (state.vetMode != null) $('#vetMode').value = String(state.vetMode);

          if (state.ffszvPct != null) $('#ffszvPct').value = state.ffszvPct;
          if (state.ffszvReplace != null) $('#ffszvReplace').value = String(state.ffszvReplace);

          if (state.instPts) $('#instPts').value = state.instPts;
          if (state.milPts) $('#milPts').value = state.milPts;

          // program rules
          $$('.progSub').forEach(cb => cb.checked = false);
          if (state.prog) {
            if (state.prog.accepted) state.prog.accepted.forEach(name => {
              const cb = $$('.progSub').find(x => x.value === name);
              if (cb) cb.checked = true;
            });
            if (state.prog.minEmelt != null) $('#minEmelt').value = String(state.prog.minEmelt);
            if (state.prog.link) $('#progLink').value = state.prog.link;
          }
        }

        if (state.mode === 'practice') {
          if (state.practiceMax) $('#practiceMax').value = state.practiceMax;
          fillPracticeScore();
          if (state.practiceScore) $('#practiceScore').value = state.practiceScore;

          if (state.milPtsPractice != null) $('#milPtsPractice').value = String(state.milPtsPractice);
        }

        refreshMaxBadge();
      }

      // Unicode-safe base64
      function encodeState(obj) {
        const json = JSON.stringify(obj);
        const bytes = new TextEncoder().encode(json);
        let bin = '';
        for (const b of bytes) bin += String.fromCharCode(b);
        return btoa(bin);
      }
      function decodeState(s) {
        const bin = atob(s);
        const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
        const json = new TextDecoder().decode(bytes);
        return JSON.parse(json);
      }

      function syncURL() {
        const s = currentState();
        const q = new URLSearchParams({ s: encodeState(s) });
        history.replaceState(null, '', location.pathname + '?' + q.toString());
      }
      function readURL() {
        const u = new URL(location.href);
        const s = u.searchParams.get('s');
        if (!s) return null;
        try { return decodeState(s); } catch { return null; }
      }

      function saveState() { localStorage.setItem('erettsegi_calc_state_v5', JSON.stringify(currentState())); }
      function loadState() {
        try {
          const s5 = JSON.parse(localStorage.getItem('erettsegi_calc_state_v5'));
          if (s5) applyState(s5);
          else {
            const s4 = JSON.parse(localStorage.getItem('erettsegi_calc_state_v4')); if (s4) applyState(s4);
            const s3 = JSON.parse(localStorage.getItem('erettsegi_calc_state_v3')); if (s3) applyState(s3);
            const s2 = JSON.parse(localStorage.getItem('erettsegi_calc_state_v2')); if (s2) applyState(s2);
            const s1 = JSON.parse(localStorage.getItem('erettsegi_calc_state')); if (s1) applyState(s1);
          }
        } catch { }

        const fromURL = readURL();
        if (fromURL) applyState(fromURL);
      }

      function copyLink() {
        syncURL();
        navigator.clipboard.writeText(location.href).then(() => { alert('Link v√°g√≥lapra m√°solva'); });
      }
      $('#shareBtn')?.addEventListener('click', copyLink);
      $('#shareBtn2')?.addEventListener('click', copyLink);
      $('#shareBtn3')?.addEventListener('click', copyLink);

      $('#resetBtn')?.addEventListener('click', () => {
        localStorage.removeItem('erettsegi_calc_state_v5');
        localStorage.removeItem('erettsegi_calc_state_v4');
        localStorage.removeItem('erettsegi_calc_state_v3');
        localStorage.removeItem('erettsegi_calc_state_v2');
        localStorage.removeItem('erettsegi_calc_state');
        location.href = location.pathname;
      });
      $('#saveBtn')?.addEventListener('click', saveState);

      // Init
      applyProfile('2025K');
      refreshInstAndMilSelects();
      loadState();
      calc();
    })();
  </script>
</body>

</html>
